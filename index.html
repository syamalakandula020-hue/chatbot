<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Syamala Science Assistant</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <style>
        :root {
            --pink-glow: rgba(236, 72, 153, 0.4);
            --bg-dark: #0b0f1a;
        }

        body {
            background-color: var(--bg-dark);
            color: #f1f5f9;
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            overflow: hidden;
        }

        .animate-spin-slow {
            animation: spin 12s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* Avatar Pulsing Glow */
        .avatar-container.speaking .glow-ring {
            position: absolute;
            inset: -8px;
            border: 4px solid #ec4899;
            border-radius: 9999px;
            animation: ping 1.5s cubic-bezier(0, 0, 0.2, 1) infinite;
            opacity: 0.4;
        }

        @keyframes ping {
            75%, 100% { transform: scale(1.4); opacity: 0; }
        }

        /* Frequency Bars Animation */
        .freq-bar {
            width: 6px;
            background-color: #475569;
            border-radius: 99px;
            height: 8px;
            transition: all 0.2s ease;
        }

        .avatar-container.speaking .freq-bar {
            background-color: #ec4899;
            animation: vocal-bounce 0.5s ease-in-out infinite alternate;
        }

        @keyframes vocal-bounce {
            from { height: 10px; }
            to { height: 40px; }
        }

        /* Message Bubbles */
        .msg-assistant {
            background-color: #1f2937;
            border: 1px solid #374151;
            border-top-left-radius: 0;
        }

        .msg-user {
            background-color: #db2777;
            color: white;
            border-top-right-radius: 0;
        }

        .prose code { color: #f472b6; background: rgba(0,0,0,0.3); padding: 0.2rem; border-radius: 4px; }
        
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #374151; border-radius: 10px; }

        .dot-pulse {
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 1; }
        }

        /* Scrubber Styling */
        input[type="range"].audio-scrubber {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 4px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 99px;
            outline: none;
            cursor: pointer;
        }

        input[type="range"].audio-scrubber::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 12px;
            height: 12px;
            background: #ec4899;
            border-radius: 50%;
            transition: all 0.2s;
            box-shadow: 0 0 10px rgba(236, 72, 153, 0.4);
        }

        input[type="range"].audio-scrubber:hover::-webkit-slider-thumb {
            transform: scale(1.2);
            box-shadow: 0 0 15px rgba(236, 72, 153, 0.6);
        }
    </style>
</head>
<body class="flex h-screen w-full">

    <!-- Sidebar -->
    <aside class="hidden md:flex flex-col w-64 border-r border-slate-800 bg-[#111827]">
        <div class="p-6 flex items-center gap-3">
            <div class="bg-pink-500 p-2 rounded-lg shadow-lg">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-white animate-spin-slow"><circle cx="12" cy="12" r="1"/><path d="M20.2 20.2c2.04-2.03.02-7.36-4.5-11.9-4.54-4.52-9.87-6.54-11.9-4.5s-.02 7.36 4.5 11.9c4.54 4.52 9.87 6.54 11.9 4.5Z"/><path d="M15.8 8.3c4.54-4.52 6.56-9.85 4.52-11.88s-7.36.02-11.9 4.55-6.56 9.85-4.52 11.88 7.36-.02 11.9-4.55Z"/></svg>
            </div>
            <h1 class="text-xl font-bold tracking-tight text-white">Syamala</h1>
        </div>

        <div id="avatarContainer" class="px-6 mb-8 mt-4 avatar-container flex flex-col items-center">
            <div class="relative w-32 h-32 rounded-full flex items-center justify-center bg-slate-800/50 border-2 border-slate-700 transition-all duration-300">
                <div class="glow-ring"></div>
                <div id="avatarIcon" class="relative z-10 text-slate-500 transition-all duration-500">
                    <svg xmlns="http://www.w3.org/2000/svg" width="60" height="60" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                </div>
            </div>
            
            <!-- Frequency bars -->
            <div class="mt-8 flex items-end justify-center gap-2 h-12">
                <div class="freq-bar" style="animation-delay: 0.1s"></div>
                <div class="freq-bar" style="animation-delay: 0.3s"></div>
                <div class="freq-bar" style="animation-delay: 0.5s"></div>
                <div class="freq-bar" style="animation-delay: 0.2s"></div>
                <div class="freq-bar" style="animation-delay: 0.4s"></div>
            </div>
            
            <div class="text-center mt-4">
                <span id="statusText" class="text-[10px] font-black tracking-[0.2em] uppercase text-slate-500 transition-colors duration-300">Awaiting Input</span>
            </div>
        </div>

        <div class="p-4 border-t border-slate-800 mt-auto flex flex-col gap-2">
            <button id="voiceInitBtn" class="flex items-center justify-center gap-2 w-full p-3 rounded-xl bg-pink-600 text-white font-bold animate-pulse shadow-xl hover:bg-pink-500 transition-all">
                Initialize Voice
            </button>
            <div id="voiceStatusRow" class="hidden flex items-center justify-between px-2 text-slate-500">
                <div class="flex items-center gap-2">
                    <div id="voiceLiveIndicator" class="w-2 h-2 rounded-full bg-slate-600"></div>
                    <span class="text-[10px] font-bold uppercase tracking-widest">Audio Link Live</span>
                </div>
                <div class="flex items-center gap-2">
                    <button id="voiceToggleBtn" class="p-1 hover:text-pink-500 transition-colors" title="Toggle Voice">
                        <svg id="v-on" class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><path d="M15.54 8.46a5 5 0 0 1 0 7.07"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14"/></svg>
                        <svg id="v-off" class="w-5 h-5 hidden" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><line x1="23" y1="9" x2="17" y2="15"/><line x1="17" y1="9" x2="23" y2="15"/></svg>
                    </button>
                    <button id="voiceDeinitBtn" class="p-1 hover:text-red-500 transition-colors" title="Stop Voice & Reset">
                        <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="6" y="6" width="12" height="12" rx="2"/><circle cx="12" cy="12" r="10"/></svg>
                    </button>
                </div>
            </div>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col h-full overflow-hidden">
        <header class="h-16 flex items-center justify-between px-8 border-b border-slate-800/50 bg-[#0b0f1a]/80 backdrop-blur-md">
            <div class="flex items-center gap-3">
                <div id="activeDot" class="w-2 h-2 rounded-full bg-slate-600"></div>
                <h2 class="text-xs font-bold tracking-widest uppercase opacity-80 text-white">Syamala Scientific Intelligence</h2>
            </div>
        </header>

        <div id="chatContainer" class="flex-1 overflow-y-auto p-8 space-y-6">
            <div class="flex justify-start">
                <div class="msg-assistant max-w-[85%] p-4 rounded-2xl text-sm text-slate-200 leading-relaxed shadow-sm">
                    Syamala is online. Please click <strong>Initialize Voice</strong> to enable vocal transmission.
                </div>
            </div>
        </div>

        <div class="p-6 bg-[#0b0f1a]/80 border-t border-slate-800/30">
            <form id="chatForm" class="max-w-3xl mx-auto relative">
                <input type="text" id="userInput" autocomplete="off" placeholder="Ask a scientific question..." 
                    class="w-full bg-slate-900 border border-slate-700 rounded-2xl p-4 pr-16 outline-none focus:border-pink-600 transition-all text-sm text-white">
                <button type="submit" id="sendBtn" class="absolute right-3 top-1/2 -translate-y-1/2 text-pink-500 hover:text-pink-400 p-2 transition-all">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
                </button>
            </form>
        </div>
    </main>

    <script>
        const API_KEY = "AIzaSyCnxZ3Mn2WEHkBzOFFVdehlg50OO56g0yk"; 
        let isVoiceEnabled = false;
        let isSpeaking = false;
        let audioContextInitialized = false;
        let globalAudio = null;
        let currentUtterance = null;
        let isUsingFallback = false;

        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        const chatContainer = document.getElementById('chatContainer');
        const chatForm = document.getElementById('chatForm');
        const userInput = document.getElementById('userInput');
        const voiceInitBtn = document.getElementById('voiceInitBtn');
        const voiceDeinitBtn = document.getElementById('voiceDeinitBtn');
        const voiceStatusRow = document.getElementById('voiceStatusRow');
        const voiceToggleBtn = document.getElementById('voiceToggleBtn');
        const statusText = document.getElementById('statusText');
        const avatarContainer = document.getElementById('avatarContainer');
        const avatarIcon = document.getElementById('avatarIcon');
        const activeDot = document.getElementById('activeDot');
        const voiceLiveIndicator = document.getElementById('voiceLiveIndicator');

        function addMessage(content, role, isTemp = false) {
            const div = document.createElement('div');
            div.className = `flex ${role === 'user' ? 'justify-end' : 'justify-start'}`;
            
            const inner = document.createElement('div');
            inner.className = `${role === 'user' ? 'msg-user' : 'msg-assistant'} max-w-[85%] p-4 rounded-2xl text-sm leading-relaxed shadow-md prose prose-invert`;
            
            if (isTemp) {
                inner.innerText = content;
                inner.classList.add('dot-pulse');
                div.id = 'loading-bubble';
            } else {
                inner.innerHTML = marked.parse(content);
                inner.dataset.rawText = content; // Store for playback
            }
            
            if (!isTemp && role === 'assistant') {
                const playerContainer = document.createElement('div');
                playerContainer.className = 'mt-3 flex items-center gap-3 border-t border-slate-700/50 pt-3 bg-slate-900/50 p-3 rounded-xl player-ui';
                
                const playBtn = document.createElement('button');
                playBtn.className = 'play-pause-btn p-2 rounded-full bg-pink-600/20 text-pink-500 hover:bg-pink-600/40 transition-all flex items-center justify-center';
                playBtn.innerHTML = `<svg class="w-5 h-5 play-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg><svg class="w-5 h-5 pause-icon hidden" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>`;
                
                const timeInfo = document.createElement('div');
                timeInfo.className = 'flex flex-col gap-0.5';
                
                const timeLabel = document.createElement('span');
                timeLabel.className = 'text-[9px] font-black tracking-widest text-slate-500 uppercase';
                timeLabel.innerText = 'Audio Sync';
                
                const durationLabel = document.createElement('span');
                durationLabel.className = 'time-display text-[10px] font-mono text-slate-400';
                durationLabel.innerText = '00:00 / --:--';
                
                const scrubber = document.createElement('input');
                scrubber.type = 'range';
                scrubber.className = 'audio-scrubber flex-1 mx-2';
                scrubber.min = 0;
                scrubber.max = 100;
                scrubber.value = 0;

                timeInfo.appendChild(timeLabel);
                timeInfo.appendChild(durationLabel);

                playBtn.onclick = () => {
                    if (window.activeAudioPlayer === playerContainer) {
                        if (isUsingFallback) {
                            if (speechSynthesis.speaking) {
                                if (speechSynthesis.paused) speechSynthesis.resume();
                                else speechSynthesis.pause();
                            } else {
                                const textContent = inner.dataset.rawText || inner.innerText.replace(/Audio Sync.*$/s, '').trim();
                                speakWithWebSpeech(textContent, playerContainer);
                            }
                        } else if (globalAudio) {
                            if (globalAudio.paused) globalAudio.play();
                            else globalAudio.pause();
                        }
                    } else {
                        const textContent = inner.dataset.rawText || inner.innerText.replace(/Audio Sync.*$/s, '').trim();
                        generateVoice(textContent, playerContainer);
                    }
                };

                scrubber.oninput = (e) => {
                    if (window.activeAudioPlayer === playerContainer) {
                        if (!isUsingFallback && globalAudio && globalAudio.duration) {
                            const time = (e.target.value / 100) * globalAudio.duration;
                            globalAudio.currentTime = time;
                        }
                    }
                };

                scrubber.onmousedown = () => { scrubber.dragging = true; };
                scrubber.onmouseup = () => { scrubber.dragging = false; };
                scrubber.ontouchstart = () => { scrubber.dragging = true; };
                scrubber.ontouchend = () => { scrubber.dragging = false; };
                
                playerContainer.appendChild(playBtn);
                playerContainer.appendChild(scrubber);
                playerContainer.appendChild(timeInfo);
                inner.appendChild(playerContainer);
            }
            
            div.appendChild(inner);
            chatContainer.appendChild(div);
            chatContainer.scrollTop = chatContainer.scrollHeight;

            if (!isTemp && window.MathJax) {
                MathJax.typesetPromise([inner]);
            }
            return div;
        }

        async function fetchWithRetry(url, options, retries = 2) {
            let delay = 300;
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (response.ok) return await response.json();
                    if (response.status !== 429) break;
                    await new Promise(r => setTimeout(r, delay));
                    delay *= 2;
                } catch (e) {
                    if (i === retries - 1) throw e;
                    await new Promise(r => setTimeout(r, delay));
                    delay *= 2;
                }
            }
            throw new Error("Core Connection Failed");
        }

        function playPCM(base64Data) {
            try {
                const binaryString = window.atob(base64Data);
                const len = binaryString.length;
                const bytes = new Uint8Array(len);
                for (let i = 0; i < len; i++) bytes[i] = binaryString.charCodeAt(i);

                const sampleRate = 24000;
                const wavHeader = new ArrayBuffer(44);
                const view = new DataView(wavHeader);

                view.setUint32(0, 0x52494646, false); // "RIFF"
                view.setUint32(4, 36 + bytes.length, true);
                view.setUint32(8, 0x57415645, false); // "WAVE"
                view.setUint32(12, 0x666d7420, false); // "fmt "
                view.setUint32(16, 16, true);
                view.setUint16(20, 1, true);
                view.setUint16(22, 1, true);
                view.setUint32(24, sampleRate, true);
                view.setUint32(28, sampleRate * 2, true);
                view.setUint16(32, 2, true);
                view.setUint16(34, 16, true);
                view.setUint32(36, 0x64617461, false); // "data"
                view.setUint32(40, bytes.length, true);

                const blob = new Blob([wavHeader, bytes], { type: 'audio/wav' });
                const url = URL.createObjectURL(blob);
                
                isUsingFallback = false;
                if (speechSynthesis.speaking) speechSynthesis.cancel();
                
                if (globalAudio) {
                    globalAudio.pause();
                    globalAudio.src = '';
                }

                globalAudio = new Audio(url);
                const player = window.activeAudioPlayer;
                const playIcon = player.querySelector('.play-icon');
                const pauseIcon = player.querySelector('.pause-icon');
                const timeDisplay = player.querySelector('.time-display');
                const scrubber = player.querySelector('.audio-scrubber');

                globalAudio.onloadedmetadata = () => {
                    timeDisplay.innerText = `00:00 / ${formatTime(globalAudio.duration)}`;
                };

                globalAudio.ontimeupdate = () => {
                    const current = formatTime(globalAudio.currentTime);
                    const total = formatTime(globalAudio.duration);
                    timeDisplay.innerText = `${current} / ${total}`;
                    
                    if (!scrubber.dragging) {
                        scrubber.value = (globalAudio.currentTime / globalAudio.duration) * 100;
                    }
                };

                globalAudio.onplay = () => {
                   setSpeakingState(true);
                   playIcon.classList.add('hidden');
                   pauseIcon.classList.remove('hidden');
                   player.classList.add('border-pink-500/50');
                   player.querySelector('.play-pause-btn').classList.remove('animate-pulse');
                };

                globalAudio.onpause = () => {
                    setSpeakingState(false);
                    playIcon.classList.remove('hidden');
                    pauseIcon.classList.add('hidden');
                    player.classList.remove('border-pink-500/50');
                };

                globalAudio.onended = () => {
                    setSpeakingState(false);
                    playIcon.classList.remove('hidden');
                    pauseIcon.classList.add('hidden');
                    player.classList.remove('border-pink-500/50');
                    scrubber.value = 0; // Reset scrubber
                    URL.revokeObjectURL(url);
                };

                globalAudio.play().catch(e => {
                    console.error("Playback block", e);
                    setSpeakingState(false);
                });
            } catch (e) {
                console.error("Audio error", e);
                setSpeakingState(false);
            }
        }

        function setSpeakingState(active) {
            isSpeaking = active;
            if (active) {
                avatarContainer.classList.add('speaking');
                avatarIcon.classList.replace('text-slate-500', 'text-pink-400');
                avatarIcon.classList.add('scale-110');
                statusText.innerText = "Broadcasting Voice";
                statusText.classList.replace('text-slate-500', 'text-pink-400');
                activeDot.classList.replace('bg-slate-600', 'bg-pink-500');
                activeDot.classList.add('shadow-[0_0_10px_#ec4899]');
                voiceLiveIndicator.classList.replace('bg-slate-600', 'bg-pink-500');
            } else {
                avatarContainer.classList.remove('speaking');
                avatarIcon.classList.replace('text-pink-400', 'text-slate-500');
                avatarIcon.classList.remove('scale-110');
                statusText.innerText = "Awaiting Input";
                statusText.classList.replace('text-pink-400', 'text-slate-500');
                activeDot.classList.replace('bg-pink-500', 'bg-slate-600');
                activeDot.classList.remove('shadow-[0_0_10px_#ec4899]');
                voiceLiveIndicator.classList.replace('bg-pink-500', 'bg-slate-600');
            }
        }

        async function generateVoice(text, player = null) {
            if (!isVoiceEnabled || !audioContextInitialized) {
                if (!audioContextInitialized) alert("Please click 'Initialize Voice' first.");
                return;
            }
            
            if (player) {
                window.activeAudioPlayer = player;
                player.querySelector('.play-pause-btn').classList.add('animate-pulse');
                player.querySelector('.time-display').innerText = 'Loading...';
            }
            
            // Clean text to avoid reading markdown/latex symbols
            const cleanText = text.replace(/[$#*`]/g, '').substring(0, 500); 

            try {
                const res = await fetchWithRetry(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: `Say clearly and concisely: ${cleanText}` }] }],
                        generationConfig: {
                            responseModalities: ["AUDIO"],
                            speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName: "Aoede" } } }
                        }
                    })
                });
                const pcm = res.candidates?.[0]?.content?.parts?.[0]?.inlineData?.data;
                if (pcm) {
                    console.log("Premium sound received.");
                    playPCM(pcm);
                } else {
                    throw new Error("No premium audio data received.");
                }
            } catch (e) { 
                console.warn("Premium TTS failed, triggering fallback:", e.message); 
                if (player) {
                    player.querySelector('.play-pause-btn').classList.remove('animate-pulse');
                    player.querySelector('.time-display').innerText = 'Initializing Standard Voice...';
                }
                speakWithWebSpeech(text, player);
            }
        }

        function speakWithWebSpeech(text, player) {
            console.log("Starting Web Speech Fallback...");
            if (globalAudio) {
                globalAudio.pause();
                globalAudio.src = '';
            }
            if (speechSynthesis.speaking) speechSynthesis.cancel();

            isUsingFallback = true;
            window.activeAudioPlayer = player;
            
            const playIcon = player.querySelector('.play-icon');
            const pauseIcon = player.querySelector('.pause-icon');
            const timeDisplay = player.querySelector('.time-display');
            const playBtn = player.querySelector('.play-pause-btn');
            const scrubber = player.querySelector('.audio-scrubber');

            const cleanText = text.replace(/[$#*`]/g, '');
            console.log("Speaking text length:", cleanText.length);
            
            currentUtterance = new SpeechSynthesisUtterance(cleanText);
            
            const setVoice = () => {
                const voices = speechSynthesis.getVoices();
                const preferredVoice = voices.find(v => v.name.includes("Female") || v.name.includes("Google US English")) || voices[0];
                if (preferredVoice) {
                    currentUtterance.voice = preferredVoice;
                    console.log("Voice selected:", preferredVoice.name);
                }
            };

            setVoice();
            if (speechSynthesis.onvoiceschanged !== undefined) {
                speechSynthesis.onvoiceschanged = setVoice;
            }

            let progressInterval = null;
            let elapsedTotal = 0;
            let lastUpdate = 0;
            // Roughly 200 words per minute -> 15 characters per second
            const estDuration = (cleanText.length / 15); 
            
            function updateFallbackProgress() {
                if (speechSynthesis.speaking && !speechSynthesis.paused && !scrubber.dragging) {
                    const now = Date.now();
                    if (lastUpdate > 0) elapsedTotal += (now - lastUpdate) / 1000;
                    lastUpdate = now;
                    
                    const progress = Math.min((elapsedTotal / estDuration) * 100, 99);
                    scrubber.value = progress;
                    timeDisplay.innerText = `${formatTime(elapsedTotal)} / ${formatTime(estDuration)}`;
                } else {
                    lastUpdate = 0;
                }
            }

            currentUtterance.onstart = () => {
                setSpeakingState(true);
                playIcon.classList.add('hidden');
                pauseIcon.classList.remove('hidden');
                player.classList.add('border-blue-500/50'); // Blue for standard voice
                playBtn.classList.remove('animate-pulse');
                lastUpdate = Date.now();
                progressInterval = setInterval(updateFallbackProgress, 100);
            };

            currentUtterance.onresume = () => {
                lastUpdate = Date.now();
                setSpeakingState(true);
                playIcon.classList.add('hidden');
                pauseIcon.classList.remove('hidden');
            };

            currentUtterance.onboundary = (e) => {
                // Secondary backup for progress
                if (!scrubber.dragging && cleanText.length > 0) {
                    const ratio = e.charIndex / cleanText.length;
                    // Only update if it's further than the timer to avoid jumps
                    if (ratio * 100 > scrubber.value) scrubber.value = ratio * 100;
                }
            };

            currentUtterance.onpause = () => {
                setSpeakingState(false);
                playIcon.classList.remove('hidden');
                pauseIcon.classList.add('hidden');
            };

            currentUtterance.onresume = () => {
                setSpeakingState(true);
                playIcon.classList.add('hidden');
                pauseIcon.classList.remove('hidden');
            };

            currentUtterance.onend = () => {
                clearInterval(progressInterval);
                setSpeakingState(false);
                playIcon.classList.remove('hidden');
                pauseIcon.classList.add('hidden');
                player.classList.remove('border-blue-500/50');
                timeDisplay.innerText = `Standard Voice (Ended)`;
                scrubber.value = 0;
            };

            currentUtterance.onerror = (e) => {
                console.error("Web Speech error", e);
                setSpeakingState(false);
                playBtn.classList.remove('animate-pulse');
                timeDisplay.innerText = 'Voice Failed';
            };

            speechSynthesis.speak(currentUtterance);
        }

        function deinitializeVoice() {
            console.log("De-initializing vocal engine...");
            if (globalAudio) {
                globalAudio.pause();
                globalAudio.src = '';
            }
            if (speechSynthesis.speaking) speechSynthesis.cancel();
            
            isVoiceEnabled = false;
            audioContextInitialized = false;
            setSpeakingState(false);
            
            voiceInitBtn.classList.remove('hidden');
            voiceStatusRow.classList.replace('flex', 'hidden');
            
            // Re-render chat to reset player states if needed or just clear active player
            window.activeAudioPlayer = null;
            
            addMessage("Vocal engine de-synchronized. Syamala is now in silent mode.", "assistant");
        }

        voiceInitBtn.onclick = () => {
            const AudioContext = window.AudioContext || window.webkitAudioContext;
            if (AudioContext) {
                const ctx = new AudioContext();
                ctx.resume().then(() => {
                    audioContextInitialized = true;
                    isVoiceEnabled = true;
                    voiceInitBtn.classList.add('hidden');
                    voiceStatusRow.classList.replace('hidden', 'flex');
                    addMessage("Vocal engine synchronized. Audio output optimized for L16/24kHz.", "assistant");
                });
            }
        };

        voiceDeinitBtn.onclick = () => {
            deinitializeVoice();
        };

        voiceToggleBtn.onclick = () => {
            isVoiceEnabled = !isVoiceEnabled;
            if (isVoiceEnabled) {
                document.getElementById('v-on').classList.remove('hidden');
                document.getElementById('v-off').classList.add('hidden');
            } else {
                document.getElementById('v-on').classList.add('hidden');
                document.getElementById('v-off').classList.remove('hidden');
            }
        };

        chatForm.onsubmit = async (e) => {
            e.preventDefault();
            const val = userInput.value.trim();
            if (!val) return;

            addMessage(val, 'user');
            userInput.value = '';
            
            const loader = addMessage("Syamala is thinking...", 'assistant', true);

            try {
                const res = await fetchWithRetry(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: val }] }],
                        systemInstruction: {
                            parts: [{ text: "Your name is Syamala. You are a highly intelligent and friendly science assistant. You MUST ONLY answer questions related to science (Physics, Chemistry, Biology, Astronomy, Earth Science, etc.). If a question is NOT related to science, politely inform the user that you only specialize in scientific topics. Keep responses very short (1-2 sentences) so they sound natural when spoken. Use LaTeX for formulas." }]
                        }
                    })
                });

                const text = res.candidates?.[0]?.content?.parts?.[0]?.text || "No data.";
                loader.remove();
                addMessage(text, 'assistant');
                
                if (isVoiceEnabled) {
                    const lastMsg = chatContainer.lastElementChild;
                    const player = lastMsg.querySelector('.player-ui');
                    if (player) generateVoice(text, player);
                }
            } catch (e) {
                loader.remove();
                console.error("Chat logic error:", e);
                addMessage("I'm sorry, I'm having trouble connecting to my knowledge base. Please check your connection or try again shortly.", 'assistant');
            }
        };
    </script>
</body>
</html>